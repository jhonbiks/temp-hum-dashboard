<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>HandHeld Prototype — Live Sheet Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 16px; }
    header { display:flex; align-items:center; gap:12px; }
    h1 { margin:0; font-size:1.25rem; }
    .controls { margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    #tableWrap { max-width:100%; overflow:auto; margin-top:12px; border-radius:8px; padding:8px; background:#f8f8f8;}
    table { border-collapse:collapse; width:100%; }
    th, td { padding:6px 8px; text-align:left; border-bottom:1px solid #e2e2e2; }
    #chartCard { margin-top:12px; padding:12px; background:#fff; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.05); }
    .small { font-size:0.85rem; color:#666; }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>HandHeld Prototype — Live Data</h1>
      <div class="small">Source: Google Sheet (ID embedded in page)</div>
    </div>
  </header>

  <div class="controls">
    <label>Auto-refresh:
      <select id="autoRefresh">
        <option value="0">Off</option>
        <option value="15">15s</option>
        <option value="30">30s</option>
        <option value="60" selected>60s</option>
      </select>
    </label>
    <button id="refreshBtn">Refresh now</button>
    <div id="status" class="small" style="margin-left:8px"></div>
  </div>

  <div id="chartCard">
    <canvas id="timeseries" height="140"></canvas>
  </div>

  <div id="tableWrap">
    <table id="dataTable" aria-describedby="tableCaption">
      <caption id="tableCaption" style="text-align:left; padding:6px 0;"></caption>
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

<script>
/*
  Simple static viewer for a Google Sheet (public / published).
  How it works:
   - Uses Google Visualization JSON endpoint:
     https://docs.google.com/spreadsheets/d/{SHEET_ID}/gviz/tq?tqx=out:json&gid={GID}
   - Parses the gviz JSON -> builds table and a chart (Chart.js)
   - To work publicly, the sheet must be either "Published to web" OR shared so "Anyone with the link" can view.
*/

// ----- CONFIG -----
const SHEET_ID = '138gz7ZmlVvjCXWaPDm7YH3ROI9pYiZZGtiZsHiCxZI0'; // <--- your sheet ID
const GID = '0';            // sheet gid (tab). You supplied gid=0.
const TIME_COLUMN_INDEX = 0; // which column has the timestamp/date (0-based)
const VALUE_COLUMN_INDEX = 1; // which column has numeric value (0-based)
let autoRefreshInterval = null;
// -------------------

const statusEl = document.getElementById('status');
const refreshBtn = document.getElementById('refreshBtn');
const autoSel = document.getElementById('autoRefresh');

refreshBtn.addEventListener('click', fetchAndRender);
autoSel.addEventListener('change', () => {
  const s = Number(autoSel.value);
  if (autoRefreshInterval) {
    clearInterval(autoRefreshInterval);
    autoRefreshInterval = null;
  }
  if (s > 0) {
    autoRefreshInterval = setInterval(fetchAndRender, s * 1000);
  }
});

// Chart.js setup
const ctx = document.getElementById('timeseries').getContext('2d');
const chart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: [],
    datasets: [{
      label: 'Sensor Value',
      data: [],
      tension: 0.2,
      pointRadius: 2
    }]
  },
  options: {
    responsive: true,
    plugins: { legend: { display: true } },
    scales: {
      x: { 
        type: 'time',
        time: { tooltipFormat: 'MMM d yyyy HH:mm', unit: 'minute' },
        title: { display: true, text: 'Time' }
      },
      y: { title: { display: true, text: 'Value' } }
    }
  }
});

// Parse Google Visualization response wrapper
function parseGViz(jsonText) {
  // response is like: google.visualization.Query.setResponse({...});
  const re = /google\.visualization\.Query\.setResponse\(([\s\S]+)\)/;
  const m = jsonText.match(re);
  if (!m) throw new Error('Unexpected GViz response format.');
  return JSON.parse(m[1]);
}

async function fetchSheet() {
  // using the GViz endpoint
  const url = `https://docs.google.com/spreadsheets/d/e/2PACX-1vTq0y8-I6AvCUyPBppc4SZ3htd7OBWlSAM-S7DGP29vhaDqeyxhND5tVRPAOkG_XVZHawuCQPsbI77F/pubhtml`;
  statusEl.textContent = 'Fetching...';
  const res = await fetch(url, { cache: 'no-store' });
  if (!res.ok) throw new Error('Network response not OK: ' + res.status);
  const text = await res.text();
  const parsed = parseGViz(text);
  return parsed;
}

function gvizToArray(gviz) {
  // returns { cols: [...names], rows: [ [c0, c1, ...], ... ] }
  const cols = gviz.table.cols.map(c => c.label || c.id || '');
  const rows = gviz.table.rows.map(r => {
    return r.c.map(cell => {
      if (!cell) return '';
      // cell.v is the raw value, cell.f is formatted
      return cell.v !== undefined ? cell.v : (cell.f !== undefined ? cell.f : '');
    });
  });
  return { cols, rows };
}

function renderTable(cols, rows) {
  const thead = document.getElementById('thead');
  const tbody = document.getElementById('tbody');
  thead.innerHTML = '';
  tbody.innerHTML = '';

  // header
  const headerRow = document.createElement('tr');
  cols.forEach(c => {
    const th = document.createElement('th');
    th.textContent = c || 'Column';
    headerRow.appendChild(th);
  });
  thead.appendChild(headerRow);

  // body
  rows.forEach(r => {
    const tr = document.createElement('tr');
    r.forEach(v => {
      const td = document.createElement('td');
      td.textContent = v;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });

  document.getElementById('tableCaption').textContent = `Showing ${rows.length} rows from the sheet.`;
}

function renderChart(rows) {
  // Expecting rows like [ [timestamp, value], ... ]
  const labels = [];
  const data = [];
  rows.forEach(r => {
    const t = r[TIME_COLUMN_INDEX];
    const v = r[VALUE_COLUMN_INDEX];
    // Try to parse time; Google may already give JS Date serial or string
    let dt = null;
    if (typeof t === 'string') {
      // try ISO or localized formats
      dt = new Date(t);
    } else if (typeof t === 'number') {
      // If it's a JS Date serial (milliseconds) or Excel serial — assume ms
      dt = new Date(t);
    } else {
      dt = new Date(String(t));
    }
    if (isNaN(dt)) {
      // fallback: use index as label
      labels.push('');
    } else {
      labels.push(dt);
    }
    const num = Number(v);
    data.push(isFinite(num) ? num : null);
  });

  chart.data.labels = labels;
  chart.data.datasets[0].data = data;
  chart.update();
}

async function fetchAndRender() {
  try {
    const gviz = await fetchSheet();
    const { cols, rows } = gvizToArray(gviz);
    // rows may contain empty trailing rows; filter rows that are entirely empty
    const validRows = rows.filter(r => r.some(cell => cell !== '' && cell !== null));
    renderTable(cols, validRows);
    renderChart(validRows);
    statusEl.textContent = `Last update: ${new Date().toLocaleString()}`;
  } catch (err) {
    statusEl.textContent = 'Error: ' + err.message;
    console.error(err);
  }
}

// initial load
fetchAndRender();
</script>
</body>
</html>

