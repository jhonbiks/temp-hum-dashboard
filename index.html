<!DOCTYPE html>
<html>
<head>
  <title>Smart Temp & Hum Dashboard</title>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    #charts {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
    }
    .chart-container {
      width: 45%;
      min-width: 300px;
      height: 300px;
      margin: 20px 0;
    }
    input { margin: 5px; padding: 5px; width: 100px; }
    button { padding: 5px 15px; }
  </style>
</head>
<body>
  <h1>Smart Temp & Hum Dashboard</h1>
  <p><strong>Latest Temperature:</strong> <span id="latestTemp">--</span> °C</p>
  <p><strong>Latest Humidity:</strong> <span id="latestHum">--</span> %</p>

  <div id="charts">
    <div id="chart_temp" class="chart-container"></div>
    <div id="chart_hum" class="chart-container"></div>
  </div>

  <h2>Set Thresholds</h2>
  <form id="thresholdForm">
    <input type="number" id="tempThreshold" step="0.1" placeholder="Temp Threshold">
    <input type="number" id="humThreshold" step="0.1" placeholder="Hum Threshold">
    <button type="submit">Update Thresholds</button>
  </form>

  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTe6lsYmds4391Gzp0MADP6CTgly8gI4cir2JlbJcoR9SSDppZw5rPXHuGfufWOGKXh9inmChEaZ8Ak/pub?gid=0&single=true&output=csv';
    const updateUrl = 'https://script.google.com/macros/s/AKfycbzAwbJF-2ePRBOdGfBICTG50xJFMkygAbhTwrogNeeMOQNHLc3hM07-8IoSGsD6IBsb/exec';

    let tempThreshold = 30, humThreshold = 80;

    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(fetchAndDraw);
    setInterval(fetchAndDraw, 60000);

    document.getElementById("thresholdForm").addEventListener("submit", async e => {
      e.preventDefault();
      tempThreshold = parseFloat(document.getElementById("tempThreshold").value);
      humThreshold = parseFloat(document.getElementById("humThreshold").value);
      try {
        const res = await fetch(`${updateUrl}?temp=${tempThreshold}&hum=${humThreshold}`);
        alert(`Response: ${await res.text()}`);
        fetchAndDraw();
      } catch {
        alert('❌ Failed to update thresholds');
      }
    });

    function parseCSV(data) {
      const lines = data.trim().split('\n');
      const headers = lines[0].split(',');
      return lines.slice(1).map(line => {
        const v = line.split(',');
        const o = {};
        headers.forEach((h,i) => o[h.trim()] = v[i]?.trim());
        return o;
      });
    }

    async function fetchAndDraw() {
      try {
        const csv = await (await fetch(sheetUrl)).text();
        const rows = parseCSV(csv);
        if (!rows.length) throw 'empty';

        const latest = rows[rows.length - 1];
        document.getElementById("latestTemp").textContent = latest.temp;
        document.getElementById("latestHum").textContent = latest.hum;

        drawChart(rows, 'temp', '#e67e22', 'Temperature (°C)', tempThreshold, 'chart_temp');
        drawChart(rows, 'hum', '#3498db', 'Humidity (%)', humThreshold, 'chart_hum');
      } catch (e) {
        console.error('Error loading data', e);
      }
    }

    function drawChart(rows, key, color, ylabel, threshold, containerId) {
      const data = new google.visualization.DataTable();
      data.addColumn('datetime', 'Time');
      data.addColumn('number', ylabel);
      data.addColumn('number', 'Threshold');

      rows.forEach(r => {
        const t = new Date(r.time);
        const v = parseFloat(r[key]);
        data.addRow([t, v, threshold]);
      });

      const options = {
        title: ylabel + ' Over Time',
        hAxis:{format:'h:mm a'},
        vAxis:{title: ylabel},
        colors: [color, 'red'],
        legend:{position:'bottom'},
        series:{1:{type:'line',lineDashStyle:[4,4],visibleInLegend:false}},
        annotations:{textStyle:{fontSize:0}}
      };

      new google.visualization.LineChart(document.getElementById(containerId)).draw(data, options);
    }
  </script>
</body>
</html>
