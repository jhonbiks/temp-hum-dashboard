<!DOCTYPE html>
<html>
<head>
  <title>Smart Temp & Humidity Dashboard</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    #thresholds input {
      width: 80px;
      margin-right: 10px;
    }
    #latest {
      margin-top: 20px;
      font-size: 1.2em;
    }
  </style>
</head>
<body>
  <h1>Smart Temperature & Humidity Monitor</h1>

  <div id="thresholds">
    <label>Temp Threshold:
      <input type="number" id="tempThreshold" step="0.1" value="30">
    </label>
    <label>Hum Threshold:
      <input type="number" id="humThreshold" step="0.1" value="80">
    </label>
    <button onclick="updateThresholds()">Update Thresholds</button>
  </div>

  <div id="latest">
    <strong>Latest Reading:</strong><br>
    Temp: <span id="latestTemp">--</span> °C |
    Humidity: <span id="latestHum">--</span> %
  </div>

  <div id="chart_temp" style="width: 100%; height: 300px;"></div>
  <div id="chart_hum" style="width: 100%; height: 300px;"></div>

  <script>
    const sheetUrl = 'https://opensheet.vercel.app/15DwGVjWoF249GmMM7EoPMg1vGfQ_v937UTbjYVF0TuU/Sheet1';
    const updateUrl = 'https://script.google.com/macros/s/AKfycbzAwbJF-2ePRBOdGfBICTG50xJFMkygAbhTwrogNeeMOQNHLc3hM07-8IoSGsD6IBsb/exec';

    let tempThreshold = 30.0;
    let humThreshold = 80.0;

    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(fetchAndDraw);

    function fetchAndDraw() {
      fetch(sheetUrl)
        .then(response => response.json())
        .then(rows => {
          if (!rows || rows.length === 0) return;

          const last = rows[rows.length - 1];
          document.getElementById("latestTemp").textContent = parseFloat(last.temp).toFixed(1);
          document.getElementById("latestHum").textContent = parseFloat(last.hum).toFixed(1);

          drawCharts(rows);
        });
    }

    function drawCharts(rows) {
      const tempData = new google.visualization.DataTable();
      const humData = new google.visualization.DataTable();

      tempData.addColumn('datetime', 'Time');
      tempData.addColumn('number', 'Temperature');
      tempData.addColumn('number', 'Temp Threshold');

      humData.addColumn('datetime', 'Time');
      humData.addColumn('number', 'Humidity');
      humData.addColumn('number', 'Hum Threshold');

      rows.forEach(r => {
        const time = new Date(r.time);
        tempData.addRow([time, parseFloat(r.temp), tempThreshold]);
        humData.addRow([time, parseFloat(r.hum), humThreshold]);
      });

      const optionsTemp = {
        title: 'Temperature Over Time',
        hAxis: { title: 'Time', format: 'h:mm a' },
        vAxis: { title: 'Temperature (°C)' },
        colors: ['#e67e22', 'red'],
        legend: { position: 'bottom' },
        series: {
          0: { targetAxisIndex: 0 },
          1: { type: 'line', lineDashStyle: [4, 4], visibleInLegend: false }
        },
        annotations: { textStyle: { fontSize: 0 } } // hide little numbers
      };

      const optionsHum = {
        title: 'Humidity Over Time',
        hAxis: { title: 'Time', format: 'h:mm a' },
        vAxis: { title: 'Humidity (%)' },
        colors: ['#3498db', 'red'],
        legend: { position: 'bottom' },
        series: {
          0: { targetAxisIndex: 0 },
          1: { type: 'line', lineDashStyle: [4, 4], visibleInLegend: false }
        },
        annotations: { textStyle: { fontSize: 0 } }
      };

      const chartTemp = new google.visualization.LineChart(document.getElementById('chart_temp'));
      const chartHum = new google.visualization.LineChart(document.getElementById('chart_hum'));

      chartTemp.draw(tempData, optionsTemp);
      chartHum.draw(humData, optionsHum);
    }

    function updateThresholds() {
      const newTemp = parseFloat(document.getElementById("tempThreshold").value);
      const newHum = parseFloat(document.getElementById("humThreshold").value);
      if (!isNaN(newTemp)) tempThreshold = newTemp;
      if (!isNaN(newHum)) humThreshold = newHum;

      const url = `${updateUrl}?temp=${tempThreshold}&hum=${humThreshold}`;
      fetch(url)
        .then(response => response.text())
        .then(result => {
          console.log('✅ Threshold updated:', result);
          fetchAndDraw();
        })
        .catch(err => {
          console.error('❌ Failed to update thresholds', err);
        });
    }

    setInterval(fetchAndDraw, 60000); // refresh every 60 seconds
  </script>
</body>
</html>
