<!DOCTYPE html>
<html>
<head>
  <title>Smart Temp-Hum Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 900px;
      margin: auto;
      background-color: #f4f4f4;
    }
    h2 {
      text-align: center;
    }
    #charts {
      display: flex;
      flex-direction: column;
      gap: 40px;
      margin-top: 30px;
    }
    .latest-values {
      font-size: 1.2em;
      margin-bottom: 20px;
    }
    label {
      display: inline-block;
      width: 200px;
    }
    input {
      padding: 5px;
      margin-bottom: 10px;
      width: 100px;
    }
    button {
      padding: 10px 20px;
      font-size: 1em;
      margin-top: 10px;
    }
    #statusMsg {
      margin-top: 10px;
      color: green;
    }
  </style>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<body>
  <h2>Smart Temperature and Humidity Dashboard</h2>

  <div class="latest-values">
    <strong>Latest Temperature:</strong> <span id="latestTemp">--</span> °C<br>
    <strong>Latest Humidity:</strong> <span id="latestHum">--</span> %
  </div>

  <div>
    <h3>Set Thresholds (Send to Google Apps Script)</h3>
    <label for="tempThreshold">Temperature Threshold (°C):</label>
    <input type="number" id="tempThreshold" step="0.1"><br>

    <label for="humThreshold">Humidity Threshold (%):</label>
    <input type="number" id="humThreshold" step="0.1"><br>

    <button onclick="sendThresholds()">Send to Apps Script</button>
    <p id="statusMsg"></p>
  </div>

  <div id="charts">
    <div id="temp_chart" style="width: 100%; height: 400px;"></div>
    <div id="hum_chart" style="width: 100%; height: 400px;"></div>
  </div>

  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTe6lsYmds4391Gzp0MADP6CTgly8gI4cir2JlbJcoR9SSDppZw5rKfBcv_eMbXh7cdIHUNXL6zIfOy/pub?output=csv';

    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(drawCharts);

    function drawCharts() {
      fetch(sheetUrl)
        .then(response => response.text())
        .then(data => {
          const rows = data.trim().split('\n').slice(1).map(line => {
            const [timestamp, temp, hum] = line.split(',');
            return [new Date(timestamp), parseFloat(temp), parseFloat(hum)];
          });

          if (rows.length === 0) return;

          const latest = rows[rows.length - 1];
          document.getElementById('latestTemp').textContent = latest[1].toFixed(1);
          document.getElementById('latestHum').textContent = latest[2].toFixed(1);

          drawChart(rows, 'temp_chart', 'Temperature (°C)', 1);
          drawChart(rows, 'hum_chart', 'Humidity (%)', 2);
        });
    }

    function drawChart(rows, elementId, title, columnIndex) {
      const data = new google.visualization.DataTable();
      data.addColumn('datetime', 'Time');
      data.addColumn('number', title);

      rows.forEach(row => {
        data.addRow([row[0], row[columnIndex]]);
      });

      const options = {
        title: title + ' Over Time',
        hAxis: { title: 'Time' },
        vAxis: { title: title },
        legend: 'none',
        colors: ['#007ACC'],
        pointSize: 4
      };

      const chart = new google.visualization.LineChart(document.getElementById(elementId));
      chart.draw(data, options);
    }

    function sendThresholds() {
      const temp = document.getElementById('tempThreshold').value;
      const hum = document.getElementById('humThreshold').value;
      const scriptURL = 'https://script.google.com/macros/library/d/1ujjf1uiw6_MJOElGmlP59wpXYdjvQeUz8rXuO_2Z_MXWvyw46rwBVLnt/1';
      const url = `${scriptURL}?temp=${temp}&hum=${hum}`;

      fetch(url, { method: 'POST' })
        .then(response => {
          if (response.ok) {
            document.getElementById('statusMsg').textContent = '✅ Thresholds saved to Google Apps Script!';
            localStorage.setItem('tempThreshold', temp);
            localStorage.setItem('humThreshold', hum);
          } else {
            throw new Error('Failed to save to Apps Script');
          }
        })
        .catch(error => {
          document.getElementById('statusMsg').textContent = '❌ Error: ' + error.message;
        });
    }

    window.addEventListener('DOMContentLoaded', () => {
      const temp = localStorage.getItem('tempThreshold');
      const hum = localStorage.getItem('humThreshold');
      if (temp) document.getElementById('tempThreshold').value = temp;
      if (hum) document.getElementById('humThreshold').value = hum;
    });

    setInterval(drawCharts, 60000); // Refresh every 60 seconds
  </script>
</body>
</html>
