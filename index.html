<!DOCTYPE html>
<html>
<head>
  <title>Smart Temp & Hum Dashboard</title>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    #chart_div {
      width: 100%;
      height: 500px;
    }
    input {
      margin: 5px;
      padding: 5px;
      width: 100px;
    }
    button {
      padding: 5px 15px;
    }
  </style>
</head>
<body>
  <h1>Smart Temp & Hum Dashboard</h1>
  <p><strong>Latest Temperature:</strong> <span id="latestTemp">--</span> °C</p>
  <p><strong>Latest Humidity:</strong> <span id="latestHum">--</span> %</p>

  <div id="chart_div"></div>

  <h2>Set Thresholds</h2>
  <form id="thresholdForm">
    <input type="number" id="tempThreshold" step="0.1" placeholder="Temp Threshold">
    <input type="number" id="humThreshold" step="0.1" placeholder="Hum Threshold">
    <button type="submit">Update Thresholds</button>
  </form>

  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTe6lsYmds4391Gzp0MADP6CTgly8gI4cir2JlbJcoR9SSDppZw5rPXHuGfufWOGKXh9inmChEaZ8Ak/pub?gid=0&single=true&output=csv';
    const updateUrl = 'https://script.google.com/macros/s/AKfycbzAwbJF-2ePRBOdGfBICTG50xJFMkygAbhTwrogNeeMOQNHLc3hM07-8IoSGsD6IBsb/exec';

    let tempThreshold = 30;
    let humThreshold = 80;

    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(fetchAndDraw);

    document.getElementById("thresholdForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      tempThreshold = parseFloat(document.getElementById("tempThreshold").value);
      humThreshold = parseFloat(document.getElementById("humThreshold").value);

      const updateParams = `?temp=${tempThreshold}&hum=${humThreshold}`;
      try {
        const res = await fetch(updateUrl + updateParams);
        const msg = await res.text();
        alert("✅ Thresholds updated: " + msg);
        fetchAndDraw(); // refresh chart
      } catch (err) {
        alert("❌ Failed to update thresholds");
      }
    });

    function parseCSV(data) {
      const lines = data.trim().split('\n');
      const headers = lines[0].split(',');
      return lines.slice(1).map(line => {
        const values = line.split(',');
        const obj = {};
        headers.forEach((h, i) => {
          obj[h.trim()] = values[i] ? values[i].trim() : '';
        });
        return obj;
      });
    }

    async function fetchAndDraw() {
      try {
        const response = await fetch(sheetUrl);
        const csv = await response.text();
        const rows = parseCSV(csv);

        if (!rows.length) throw new Error("No data");

        const latest = rows[rows.length - 1];
        document.getElementById("latestTemp").textContent = latest.temp;
        document.getElementById("latestHum").textContent = latest.hum;

        const data = new google.visualization.DataTable();
        data.addColumn('datetime', 'Time');
        data.addColumn('number', 'Temp');
        data.addColumn('number', 'Hum');

        rows.forEach(row => {
          const time = new Date(row.time);
          data.addRow([time, parseFloat(row.temp), parseFloat(row.hum)]);
        });

        const options = {
          title: 'Temperature & Humidity Over Time',
          curveType: 'function',
          legend: { position: 'bottom' },
          hAxis: { title: 'Time' },
          vAxis: {
            title: 'Value',
            viewWindow: {
              min: 0,
              max: 100
            }
          },
          series: {
            0: { targetAxisIndex: 0 },
            1: { targetAxisIndex: 0 }
          },
          annotations: {
            textStyle: {
              fontSize: 0, // hide number annotations
            }
          },
          trendlines: {},
          enableInteractivity: true
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart_div'));

        const view = new google.visualization.DataView(data);
        chart.draw(view, options);

      } catch (error) {
        console.error("❌ Error:", error);
      }
    }

    setInterval(fetchAndDraw, 60000); // Auto-refresh every minute
  </script>
</body>
</html>
